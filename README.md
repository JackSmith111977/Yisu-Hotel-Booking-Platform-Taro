# 易宿 (YiSu) - 酒店预订平台

## 📖 项目简介
易宿是一款基于 **Taro 4** + **React 18** 开发的现代化酒店预订应用。项目旨在提供流畅、高效的酒店搜索与预订体验，采用组件化架构设计，支持微信小程序及多端发布。

## 🌟 项目亮点
*   **跨端架构**: 基于 **Taro 4** 开发，一套代码完美支持微信小程序、H5 等多端运行，极大降低维护成本。
*   **现代技术栈**: 使用 **React 18** + **TypeScript** 构建，确保代码的健壮性、可维护性与类型安全。
*   **轻量级状态管理**: 采用 **Zustand** 进行全局状态管理，相比 Redux 更为简洁高效，不仅减少了样板代码，还提升了应用性能。
*   **业务逻辑解耦**: 核心业务逻辑封装在 Custom Hooks (如 `useHomeLogic`) 中，实现了 UI 与逻辑的分离，便于单元测试和复用。
*   **云原生集成**: 集成 **Supabase** 和 **微信云开发 (Cloud Functions)**，构建了弹性的 Serverless 后端架构，支持快速迭代。
*   **极致交互**: 针对移动端优化的交互设计，包含级联城市选择、自定义日期范围选择等原生级体验组件。

## 🛠 技术栈
*   **核心框架**: [Taro 4.x](https://docs.taro.zone/)
*   **UI 库**: [React 18](https://react.dev/)
*   **组件库**: [NutUI React](https://nutui.jd.com/#/) (移动端组件库)
*   **语言**: [TypeScript](https://www.typescriptlang.org/)
*   **样式预处理**: SCSS (Sass)
*   **状态管理**: [Zustand](https://github.com/pmndrs/zustand)
*   **日期处理**: [Day.js](https://day.js.org/)
*   **后端服务**: Supabase, WeChat Cloud Functions

## 📅 项目进度
目前项目处于 **功能完善阶段 (Phase 2)**，核心搜索、详情及预订链路已打通，进入用户系统与个人中心开发阶段。

| 模块/页面 | 状态 | 路径/说明 |
| :--- | :---: | :--- |
| **搜索页 (首页)** | ✅ **已完成** | `src/pages/home` <br> 含城市/日期选择、标签筛选、搜索联动 |
| **搜索结果列表** | ✅ **已完成** | `src/packages/search` <br> 虚拟列表渲染、多维度筛选、推荐补位、骨架屏加载 |
| **酒店详情页** | ✅ **已完成** | `src/packages/hotel` <br> 详情展示、房型列表、智能推荐、吸顶交互 |
| **下单页** | ✅ **已完成** | `src/packages/hotel/pages/order` <br> 订单提交、库存扣减、模拟支付动画 |
| **登录/注册** | 📅 计划中 | `src/packages/auth` (已预留分包) |
| **个人中心** | 📅 计划中 | `src/pages/user` (基础路由已配置) |

### 🔍 已完成功能细节

#### 1. 搜索页 (Home)
*   **城市定位与选择**: 集成腾讯地图数据，支持自动定位及级联城市选择 (`HomeHeader`)。
*   **日期范围选择**: 支持入住/离店日期的跨月选择与校验 (`DateSelector`)。
*   **多维度筛选**: 支持“官方直营”、“特价房”等快捷标签筛选 (`FilterBar`)。
*   **逻辑复用**: 搜索状态（城市、日期、关键词、标签）统一由 `useHomeLogic` 钩子管理。

#### 2. 搜索结果 (Search List)
*   **高性能列表**: 采用 `VirtualList` 虚拟列表技术，流畅渲染大量酒店数据。
*   **高级筛选**: 支持侧边栏筛选（价格范围、星级、设施等）及综合排序。
*   **状态管理**: 完善的加载中（骨架屏）、空状态及推荐补位逻辑。

#### 3. 酒店详情 (Hotel Detail)
*   **沉浸式体验**: 顶部大图轮播、信息吸顶交互、平滑滚动定位。
*   **智能推荐**: 当选定房型不满足人数要求时，自动推荐组合房型方案。
*   **房型列表**: 展示房型详情、价格日历及预订入口。

#### 4. 交易流程 (Order)
*   **订单提交**: 完整的订单填写校验与提交逻辑，集成 Supabase 事务处理。
*   **库存管理**: 下单即时扣减库存 (RPC调用)，防止超卖。
*   **支付模拟**: 包含支付状态流转与交互动画。

## ✅ 核心任务清单
- ~~搜索结果页：虚拟列表与筛选功能~~ (已完成)
- ~~酒店详情页：基础信息与房型列表~~ (已完成)
- ~~下单页：订单提交与库存扣减~~ (已完成)
- 用户认证：登录/注册页面及 Supabase Auth 集成
- 个人中心：订单列表与状态管理
- 支付对接：接入真实支付渠道 (可选)
- 性能优化：进一步优化首屏加载速度  

## 📂 目录结构
```bash
src/
├── components/       # 公共组件库
│   └── home/         # 首页专用业务组件 (耦合度较高)
├── hooks/            # 自定义 Hooks (逻辑层)
│   └── home/         # 首页逻辑封装
├── packages/         # 分包页面 (优化小程序主包体积)
│   ├── search/       # 搜索业务包
│   ├── hotel/        # 酒店业务包
│   └── auth/         # 认证业务包
├── pages/            # 主包页面 (Tab页)
│   ├── home/         # 首页
│   └── user/         # 个人中心
├── store/            # 全局状态 (Zustand)
├── utils/            # 工具库 (路由、地图、Supabase)
└── app.config.ts     # 全局配置
```

## � 数据模型与接口映射

本章节详细说明前端接口类型定义、数据库表结构以及二者之间的字段映射关系。

### 1. Banner (广告位)

*   **前端接口**: `src/types/home/banner.ts` -> `Banner`
*   **数据库表**: `public.banners`

#### 字段映射
| Interface Property | Table Column | Type (TS) | Type (DB) | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | `id` | `number` | `bigint` | 自增主键 |
| `hotelId` | `hotel_id` | `number \| null` | `bigint` | 关联酒店ID |
| `title` | `title` | `string` | `text` | 广告标题 |
| `imageUrl` | `image_url` | `string` | `text` | 图片链接 |
| `targetUrl` | `target_url` | `string \| null` | `text` | 跳转链接 |
| `priority` | `priority` | `number` (可选) | `integer` | 排序优先级 |
| `status` | `status` | `string` (可选) | `text` | 状态 ('active'/'inactive') |

#### 表结构定义 (SQL)
```sql
create table public.banners ( 
   id bigint generated by default as identity not null, 
   hotel_id bigint null, 
   title text not null, 
   image_url text not null, 
   target_url text null, 
   priority integer null default 100, 
   status text null default 'active'::text, 
   start_time timestamp with time zone not null, 
   end_time timestamp with time zone not null, 
   created_at timestamp with time zone null default now(), 
   constraint banners_pkey primary key (id), 
   constraint banners_hotel_id_fkey foreign KEY (hotel_id) references hotels (id), 
   constraint banners_status_check check ( 
     ( 
       status = any (array['active'::text, 'inactive'::text]) 
     ) 
   ) 
 ) TABLESPACE pg_default; 

 create index IF not exists idx_banners_active on public.banners using btree (status, start_time, end_time) TABLESPACE pg_default;
```

### 2. Hotel (酒店信息)

*   **前端接口**: `src/types/detailPage/hotel.ts` -> `HotelType`
*   **数据库表**: `public.hotels`

#### 字段映射
| Interface Property | Table Column | Type (TS) | Type (DB) | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | `id` | `number` | `bigint` | 酒店ID |
| `name_zh` | `name_zh` | `string` | `text` | 中文名称 |
| `name_en` | `name_en` | `string` | `text` | 英文名称 |
| `address` | `address` | `string` | `text` | 地址 |
| `star_rating` | `star_rating` | `number` | `smallint` | 星级 |
| `opening_date` | `opening_date` | `string` | `date` | 开业日期 |
| `contact_phone` | `contact_phone` | `string` | `text` | 联系电话 |
| `image` | `image` | `string` | `text` | 主图URL |
| `status` | `status` | `string` | `text` | 状态 |
| `merchant_id` | `merchant_id` | `string` | `uuid` | 商户ID |
| `region` | `region` | `string` | `text` | 所在地区 |
| `album` | `album` | `string[]` | `text[]` | 相册列表 |
| `tags` | `tags` | `string[]` | `text[]` | 标签列表 |

#### 表结构定义 (SQL)
```sql
create table public.hotels ( 
   id bigint generated by default as identity not null, 
   name_zh text null, 
   name_en text null, 
   address text null default ''::text, 
   star_rating smallint null, 
   opening_date date null, 
   contact_phone text null, 
   image text null, 
   status text not null, 
   merchant_id uuid null, 
   updated_at timestamp with time zone null default now(), 
   rejected_reason text null, 
   region text null, 
   album text[] null, 
   tags text[] null, 
   search_text tsvector null, 
   constraint hotels_pkey primary key (id), 
   constraint hotels_name_zh_key unique (name_zh) 
 ) TABLESPACE pg_default; 

 create index IF not exists hotels_search_text_idx on public.hotels using gin (search_text) TABLESPACE pg_default; 
 
 create index IF not exists hotels_tags_idx on public.hotels using gin (tags) TABLESPACE pg_default; 
 
 create index IF not exists hotels_name_zh_trgm_idx on public.hotels using gin (name_zh gin_trgm_ops) TABLESPACE pg_default; 
 
 create index IF not exists hotels_name_en_trgm_idx on public.hotels using gin (name_en gin_trgm_ops) TABLESPACE pg_default; 
 
 create index IF not exists hotels_address_trgm_idx on public.hotels using gin (address gin_trgm_ops) TABLESPACE pg_default; 
 
 create index IF not exists hotels_region_idx on public.hotels using btree (region) TABLESPACE pg_default; 
 
 create trigger hotels_search_vector_update BEFORE INSERT 
 or 
 update OF name_zh, 
 name_en, 
 region, 
 address, 
 tags, 
 updated_at on hotels for EACH row 
 execute FUNCTION hotels_search_vector_update ();
```

### 3. RoomType (房型信息)

*   **前端接口**: `src/types/detailPage/RoomList.ts` -> `RoomType`
*   **数据库表**: `public.room_types`

#### 字段映射
| Interface Property | Table Column | Type (TS) | Type (DB) | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | `id` | `number` | `bigint` | 房型ID |
| `hotel_id` | `hotel_id` | `number` | `bigint` | 所属酒店ID |
| `name` | `name` | `string` | `text` | 房型名称 |
| `price` | `price` | `number` | `numeric` | 基础价格 |
| `quantity` | `quantity` | `number` | `integer` | 房间总量 |
| `size` | `size` | `number` | `integer` | 面积(平米) |
| `max_guests` | `max_guests` | `number` | `bigint` | 最大入住人数 |
| `description` | `description` | `string` | `text` | 描述 |
| `beds` | `beds` | `BedInfo[]` | `jsonb` | 床铺配置 |
| `images` | `images` | `string[]` | `jsonb` | 图片列表 |
| `facilities` | `facilities` | `string[]` | `jsonb` | 设施列表 |

#### 表结构定义 (SQL)
```sql
create table public.room_types ( 
   id bigint generated by default as identity not null, 
   hotel_id bigint not null, 
   name text null, 
   price numeric null, 
   size integer null, 
   description text null, 
   max_guests bigint null, 
   beds jsonb null, 
   images jsonb null, 
   facilities jsonb null, 
   constraint room_types_pkey primary key (id), 
   constraint room_types_hotel_id_fkey foreign KEY (hotel_id) references hotels (id) on update CASCADE on delete CASCADE 
 ) TABLESPACE pg_default; 
 
 create trigger room_types_search_vector_update 
 after INSERT 
 or DELETE 
 or 
 update on room_types for EACH row 
 execute FUNCTION room_types_search_vector_trigger (); 
 
 create trigger trg_auto_room_availability 
 after INSERT on room_types for EACH row 
 execute FUNCTION auto_create_room_availability ();
```

### 4. Order (订单信息)

*   **前端接口**: `src/store/bookingStore.ts` -> `BookingStore` (部分映射)
*   **数据库表**: `public.orders`

#### 字段映射
| Interface Property | Table Column | Type (TS) | Type (DB) | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | `id` | `number` | `bigint` | 订单ID |
| `userId` | `user_id` | `string` | `uuid` | 用户ID |
| `hotelId` | `hotel_id` | `number` | `bigint` | 酒店ID |
| `checkInDate` | `check_in_date` | `string` | `date` | 入住日期 |
| `checkOutDate` | `check_out_date` | `string` | `date` | 离店日期 |
| `nights` | `nights` | `number` | `integer` | 入住晚数 |
| `items` | `rooms` | `BookingItem[]` | `jsonb` | 预订房型列表 |
| `totalPrice` | `total_amount` | `number` | `numeric` | 订单总金额 |
| `guestName` | `guest_name` | `string` | `varchar` | 住客姓名 |
| `guestPhone` | `guest_phone` | `string` | `varchar` | 联系电话 |
| `specialRequests` | `special_requests`| `string` | `text` | 特殊要求 |
| `status` | `status` | `string` | `text` | 订单状态 (待付款/已支付/已取消等) |

#### 表结构定义 (SQL)
```sql
create table public.orders ( 
   id bigint generated always as identity not null, 
   user_id uuid not null, 
   hotel_id bigint not null, 
   check_in_date date not null, 
   check_out_date date not null, 
   nights integer not null, 
   adult_count integer not null default 1, 
   child_count integer not null default 0, 
   guest_name character varying(100) not null, 
   guest_phone character varying(20) not null, 
   total_amount numeric(10, 2) not null, 
   paid_amount numeric(10, 2) null default 0, 
   special_requests text null, 
   created_at timestamp with time zone null default now(), 
   updated_at timestamp with time zone null default now(), 
   rooms jsonb not null default '[]'::jsonb, 
   constraint orders_pkey primary key (id), 
   constraint orders_hotel_id_fkey foreign KEY (hotel_id) references hotels (id) 
 ) TABLESPACE pg_default;
```

### 5. Tag (标签信息)

*   **前端接口**: `src/store/tagStore.ts` -> `Tag`
*   **数据库表**: `public.tags`

#### 字段映射
| Interface Property | Table Column | Type (TS) | Type (DB) | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | `id` | `number` | `bigint` | 标签ID |
| `name` | `name` | `string` | `text` | 标签名称 |
| `category` | `category` | `string` | `text` | 标签分类 |
| `isActive` | `is_active` | `boolean` | `boolean` | 是否启用 |

#### 表结构定义 (SQL)
```sql
create table public.tags ( 
   id bigint generated always as identity not null, 
   name text not null, 
   category text not null, 
   is_active boolean not null default true, 
   created_at timestamp with time zone not null default now(), 
   constraint tags_pkey primary key (id), 
   constraint tags_name_key unique (name) 
 ) TABLESPACE pg_default;
```


## 🚀 快速开始

1.  **安装依赖**
    ```bash
    pnpm install
    ```

2.  **启动开发环境 (微信小程序)**
    ```bash
    pnpm run dev:weapp
    ```
    *请使用微信开发者工具导入 `dist` 目录进行预览*

3.  **构建生产版本**
    ```bash
    pnpm run build:weapp
    ```

---
> 文档生成时间: 2026-02-24
